<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuts & Seeds Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Cropper CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <!-- Cropper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
</head>

<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold text-gray-900">Nuts & Seeds</h1>
                </div>

                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="{% url 'dashboard_home' %}"
                        class="text-gray-600 hover:text-gray-900 transition">Dashboard</a>
                    <a href="{% url 'listCategory' %}" class="text-gray-600 hover:text-gray-900 transition">Category</a>
                    <a href="{% url 'listProduct' %}" class="text-gray-600 hover:text-gray-900 transition">Products</a>
                    <a href="{% url 'users' %}" class="text-gray-600 hover:text-gray-900 transition">Customers</a>
                    <a href="{% url 'orderList' %}" class="text-gray-600 hover:text-gray-900 transition">Orders</a>
                    <a href="{% url 'admin_signout' %}" class="text-gray-600 hover:text-gray-900 transition">Logout</a>
                </div>

                <!-- User Profile -->
                <div class="flex items-center">
                    <button class="flex items-center space-x-2">
                        <div class="rounded-full flex items-center justify-center">
                            <span class="text-black font-semibold">{{user}}</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    {% include 'messages.html' %}
    {% block content %}




    {% endblock %}

    <!-- csrf for htmx -->
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
            event.detail.headers['X-CSRFToken'] = token;
        });
    </script>

    <!-- cropper.js -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const imageInputs = document.querySelectorAll(".image-input");
            const modal = document.getElementById("cropperModal");
            const modalImage = document.getElementById("modalImage");
            const closeModal = document.getElementById("closeModal");
            const cropSave = document.getElementById("cropSave");
            let cropper, currentPreview, currentHidden;

            imageInputs.forEach(input => {
                const index = input.dataset.index;
                const preview = document.getElementById(`preview-${index}`);
                const hiddenInput = document.getElementById(`cropped-${index}`);

                input.addEventListener("change", function (e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            modalImage.src = event.target.result;
                            modal.classList.remove("hidden");

                            // Destroy old cropper
                            if (cropper) cropper.destroy();

                            // New cropper
                            cropper = new Cropper(modalImage, {
                                aspectRatio: 1,
                                viewMode: 1,
                                autoCropArea: 1,
                                responsive: true,
                            });

                            currentPreview = preview;
                            currentHidden = hiddenInput;
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
            });

            // Close modal
            closeModal.addEventListener("click", function () {
                modal.classList.add("hidden");
                if (cropper) cropper.destroy();
            });

            // Save crop
            cropSave.addEventListener("click", function (e) {
                e.preventDefault(); // <-- prevent form auto-submit here

                if (cropper && currentHidden && currentPreview) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 500,
                        height: 500
                    });
                    currentHidden.value = canvas.toDataURL("image/png");
                    currentPreview.src = currentHidden.value;
                    currentPreview.style.display = "block";

                    modal.classList.add("hidden");
                    cropper.destroy();
                }
            });
        });
    </script>


    <!-- Remove image from edit product -->
    <script>
        let croppers = {};

        function previewAndCrop(input, index) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('preview-' + index);
                img.src = e.target.result;
                img.classList.remove('hidden');
                const slot = img.closest('.image-slot');
                const addSpan = slot.querySelector('.add-image');
                if (addSpan) addSpan.style.display = 'none';

                if (croppers[index]) croppers[index].destroy();
                croppers[index] = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
        }

        /* ---------- DOM ready ---------- */
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form');
            if (!form) return console.error('Form not found');

            /* ---- click + Add ---- */
            document.addEventListener('click', e => {
                if (e.target.classList.contains('add-image')) {
                    const idx = e.target.dataset.index;
                    const fileInput = document.querySelector(`.file-input[data-index="${idx}"]`);
                    if (fileInput) fileInput.click();
                }
            });

            /* ---- click ✕ (remove) ---- */
            document.addEventListener('click', e => {
                if (!e.target.classList.contains('remove-btn')) return;

                const slot = e.target.closest('.image-slot');
                const checkbox = slot.querySelector('.remove-checkbox');
                const img = slot.querySelector('img');

                // ✅ mark for backend deletion
                if (checkbox) {
                    checkbox.checked = true;
                    console.log("Marked for deletion:", checkbox.value);
                }

                // ✅ hide preview image + remove button
                if (img) img.style.display = "none";
                e.target.style.display = "none";

                // ✅ show "+ Add" again
                let addSpan = slot.querySelector('.add-image');
                if (addSpan) {
                    addSpan.style.display = 'flex';
                }
            });

            /* ---- submit ---- */
            form.addEventListener('submit', e => {
                console.log('SUBMITTING...');
                for (let i = 1; i <= 4; i++) {
                    if (croppers[i]) {
                        const canvas = croppers[i].getCroppedCanvas({ width: 500, height: 500 });
                        const hidden = document.getElementById('cropped-' + i);
                        if (hidden) hidden.value = canvas.toDataURL('image/png');
                        console.log('Image', i, 'CROPPED');
                    }
                }
            });
        });
    </script>




</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuts & Seeds Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Cropper CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <!-- Cropper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
</head>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    body {
            font-family: 'Poppins', sans-serif;
        }
        
</style>

<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold text-gray-900">Nuts & Seeds</h1>
                </div>

                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="{% url 'dashboard_home' %}"
                        class="text-gray-600 hover:text-gray-900 transition">Dashboard</a>
                    <a href="{% url 'listCategory' %}" class="text-gray-600 hover:text-gray-900 transition">Category</a>
                    <a href="{% url 'listProduct' %}" class="text-gray-600 hover:text-gray-900 transition">Products</a>
                    <a href="{% url 'users' %}" class="text-gray-600 hover:text-gray-900 transition">Customers</a>
                    <a href="{% url 'orderList' %}" class="text-gray-600 hover:text-gray-900 transition">Orders</a>
                    <a href="{% url 'couponList' %}" class="text-gray-600 hover:text-gray-900 transition">Coupons</a>
                    <a href="{% url 'allOffers' %}" class="text-gray-600 hover:text-gray-900 transition">Offers</a>
                    <a href="{% url 'allWallet' %}" class="text-gray-600 hover:text-gray-900 transition">Wallet</a>
                    <a href="{% url 'admin_signout' %}" class="text-gray-600 hover:text-gray-900 transition">Logout</a>
                </div>

                <!-- User Profile -->
                <div class="flex items-center">
                    <button class="flex items-center space-x-2">
                        <div class="rounded-full flex items-center justify-center">
                            <span class="text-black font-semibold">{{user}}</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    {% include 'messages.html' %}
    {% block content %}




    {% endblock %}

    <!-- csrf for htmx -->
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
            event.detail.headers['X-CSRFToken'] = token;
        });
    </script>

    <!-- cropper.js -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const imageInputs = document.querySelectorAll(".image-input");
            const modal = document.getElementById("cropperModal");
            const modalImage = document.getElementById("modalImage");
            const closeModal = document.getElementById("closeModal");
            const cropSave = document.getElementById("cropSave");
            let cropper, currentPreview, currentHidden;

            imageInputs.forEach(input => {
                const index = input.dataset.index;
                const preview = document.getElementById(`preview-${index}`);
                const hiddenInput = document.getElementById(`cropped-${index}`);

                input.addEventListener("change", function (e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            modalImage.src = event.target.result;
                            modal.classList.remove("hidden");

                            // Destroy old cropper
                            if (cropper) cropper.destroy();

                            // New cropper
                            cropper = new Cropper(modalImage, {
                                aspectRatio: 1,
                                viewMode: 1,
                                autoCropArea: 1,
                                responsive: true,
                            });

                            currentPreview = preview;
                            currentHidden = hiddenInput;
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
            });

            // Close modal
            closeModal.addEventListener("click", function () {
                modal.classList.add("hidden");
                if (cropper) cropper.destroy();
            });

            // Save crop
            cropSave.addEventListener("click", function (e) {
                e.preventDefault(); // <-- prevent form auto-submit here

                if (cropper && currentHidden && currentPreview) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 500,
                        height: 500
                    });
                    currentHidden.value = canvas.toDataURL("image/png");
                    currentPreview.src = currentHidden.value;
                    currentPreview.style.display = "block";

                    modal.classList.add("hidden");
                    cropper.destroy();
                }
            });
        });
    </script>


    <!-- Remove image from edit product -->
    <script>
        let croppers = {};

        function previewAndCrop(input, index) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('preview-' + index);
                img.src = e.target.result;
                img.classList.remove('hidden');
                const slot = img.closest('.image-slot');
                const addSpan = slot.querySelector('.add-image');
                if (addSpan) addSpan.style.display = 'none';

                if (croppers[index]) croppers[index].destroy();
                croppers[index] = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
        }

        /* ---------- DOM ready ---------- */
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form');
            if (!form) return console.error('Form not found');

            /* ---- click + Add ---- */
            document.addEventListener('click', e => {
                if (e.target.classList.contains('add-image')) {
                    const idx = e.target.dataset.index;
                    const fileInput = document.querySelector(`.file-input[data-index="${idx}"]`);
                    if (fileInput) fileInput.click();
                }
            });

            /* ---- click ✕ (remove) ---- */
            document.addEventListener('click', e => {
                if (!e.target.classList.contains('remove-btn')) return;

                const slot = e.target.closest('.image-slot');
                const checkbox = slot.querySelector('.remove-checkbox');
                const img = slot.querySelector('img');

                // mark for backend deletion
                if (checkbox) {
                    checkbox.checked = true;
                    console.log("Marked for deletion:", checkbox.value);
                }

                // hide preview image + remove button
                if (img) img.style.display = "none";
                e.target.style.display = "none";

                // show "+ Add" again
                let addSpan = slot.querySelector('.add-image');
                if (addSpan) {
                    addSpan.style.display = 'flex';
                }
            });

            /* ---- submit ---- */
            form.addEventListener('submit', e => {
                console.log('SUBMITTING...');
                for (let i = 1; i <= 4; i++) {
                    if (croppers[i]) {
                        const canvas = croppers[i].getCroppedCanvas({ width: 500, height: 500 });
                        const hidden = document.getElementById('cropped-' + i);
                        if (hidden) hidden.value = canvas.toDataURL('image/png');
                        console.log('Image', i, 'CROPPED');
                    }
                }
            });
        });
    </script>



<!-- dashborad filter starts -->
<script>
function setFilter(value) {
    document.getElementById('filterType').value = value;
}

function enableCustom() {
    document.getElementById("filterType").value = "custom";
    document.getElementById("dateFields").classList.remove("hidden");
    document.getElementById("customSubmit").classList.remove("hidden");
}
</script>
<!-- dashborad filter ends-->


<!-- dashboard file download -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.getElementById("downloadMenuBtn").addEventListener("click", function () {
    const menu = document.getElementById("downloadMenu");
    menu.classList.toggle("hidden");
});

// Close dropdown if clicked outside
document.addEventListener("click", function(e) {
    const menu = document.getElementById("downloadMenu");
    const btn = document.getElementById("downloadMenuBtn");

    if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add("hidden");
    }
});
</script>

<script>
/* -----------------------------------------------------
  PART 1 — SVG → PNG (Fix for Donut Pie Charts in PDF)
-------------------------------------------------------- */
function svgToPng(svgElement) {
    return new Promise(resolve => {

        const cloneSvg = svgElement.cloneNode(true);
        cloneSvg.removeAttribute("class");

        const rect = svgElement.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;

        cloneSvg.setAttribute("width", width);
        cloneSvg.setAttribute("height", height);

        const svgText = new XMLSerializer().serializeToString(cloneSvg);
        const img = new Image();

        img.onload = function () {
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);

            resolve(canvas.toDataURL("image/png"));
        };

        img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgText)));
    });
}


/* -----------------------------------------------------
  PART 2 — Prepare Dashboard for PDF (Clone + Replace SVG)
-------------------------------------------------------- */
async function prepareDashboardForPdf() {
    const original = document.getElementById("dashboard-section");
    const clone = original.cloneNode(true);

    const svgs = clone.querySelectorAll("svg");

    for (let svg of svgs) {
        const rect = svg.getBoundingClientRect();
        const pngUrl = await svgToPng(svg);

        const img = document.createElement("img");
        img.src = pngUrl;
        img.style.width = rect.width + "px";
        img.style.height = rect.height + "px";

        svg.replaceWith(img);
    }

    clone.style.background = "white";
    clone.style.padding = "20px";

    return clone;
}


/* -----------------------------------------------------
  PART 3 — PDF DOWNLOAD BUTTON
-------------------------------------------------------- */
document.getElementById("download").addEventListener("click", async () => {
    const btn = document.getElementById("download");
    btn.innerText = "Preparing PDF...";
    btn.disabled = true;

    const clone = await prepareDashboardForPdf();

    const opt = {
        margin: 0.2,
        filename: "dashboard-report.pdf",
        image: { type: "jpeg", quality: 1 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            scrollX: 0,
            scrollY: 0
        },
        jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
    };

    html2pdf().set(opt).from(clone).save().then(() => {
        btn.innerText = "Download PDF";
        btn.disabled = false;
    });
});


/* -----------------------------------------------------
  PART 4 — PREPARE EXCEL DATA (Get Data From Django Context)
-------------------------------------------------------- */

let productData = [
    {% for item in product_show %}
    {
        Product: "{{ item.name }}",
        Quantity: "{{ item.quantity }}",
        Revenue: "{{ item.revenue }}",
        Percentage: "{{ item.percentage }}%"
    },
    {% endfor %}
];

let categoryData = [
    {% for item in category_show %}
    {
        Category: "{{ item.name }}",
        Quantity: "{{ item.quantity }}",
        Revenue: "{{ item.revenue }}",
        Percentage: "{{ item.percentage }}%"
    },
    {% endfor %}
];

let orderData = [
    {% for o in orders %}
    {
        Customer: "{{ o.user.firstname }}",
        OrderID: "{{ o.orderID }}",
        Date: "{{ o.created_at }}",
        Amount: "{{ o.total_price }}",
        Payment: "{{ o.payment_method }}",
        Status: "{{ o.orderitem.all.0.status }}"
    },
    {% endfor %}
];


/* -----------------------------------------------------
  PART 5 — FRONTEND EXCEL DOWNLOAD BUTTON
-------------------------------------------------------- */
document.getElementById("downloadExcel").addEventListener("click", () => {

    let wb = XLSX.utils.book_new();

    // Sheet 1 — Product Summary
    let ws1 = XLSX.utils.json_to_sheet(productData);
    XLSX.utils.book_append_sheet(wb, ws1, "Top Products");

    // Sheet 2 — Category Summary
    let ws2 = XLSX.utils.json_to_sheet(categoryData);
    XLSX.utils.book_append_sheet(wb, ws2, "Top Categories");

    // Sheet 3 — Recent Orders
    let ws3 = XLSX.utils.json_to_sheet(orderData);
    XLSX.utils.book_append_sheet(wb, ws3, "Recent Orders");

    XLSX.writeFile(wb, "dashboard-report.xlsx");
});
</script>



</body>

</html>
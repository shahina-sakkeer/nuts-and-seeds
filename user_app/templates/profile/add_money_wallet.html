<!-- Main Container -->
<div class="bg-white rounded-lg shadow-sm p-6">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column - Balance and Add Funds -->
        <div class="lg:col-span-1 space-y-6">
            <form action="" id="wallet-form">
                <!-- Current Balance Card -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <p class="text-sm text-gray-600 mb-2">Current Balance</p>
                    <h1 class="text-4xl font-bold text-gray-900">Rs. {{balance}}</h1>
                </div>

                <!-- Add Funds Card -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Add Funds</h2>

                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                            Amount
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">Rs. </span>
                            <input type="text" id="amount" name="amount" placeholder=" 0.00"
                                class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full bg-blue-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                        Add Funds
                    </button>
                </div>
            </form>
        </div>

        <!-- Right Column - Recent Transactions -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-sm p-6">

                <!-- Header -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                    <h2 class="text-xl font-semibold text-gray-900">Recent Transactions</h2>
                </div>
                
                <!-- Table Header-->
                <div
                    class="hidden md:grid md:grid-cols-9 gap-4 px-4 py-3 bg-gray-50 rounded-t-lg border-b border-gray-200">
                    <div class="col-span-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</div>
                    <div class="col-span-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</div>
                    <div class="col-span-2 text-xs font-semibold text-gray-600 uppercase tracking-wider text-right">
                        Amount</div>
                </div>

                <!-- Transaction Rows -->
                <div class="divide-y divide-gray-200">

                    {% if wallet_txn %}
                    {% for txn in wallet_txn %}
                    <!-- Transaction 1 -->
                    <div class="grid grid-cols-9 gap-4 px-4 py-4 hover:bg-gray-50 transition">

                        {% if txn.transaction_type == 'credit' %}
                        <div class="col-span-3 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                            </svg>
                            <span class="text-sm font-medium text-gray-900 capitalize">{{txn.transaction_type}}</span>
                        </div>
                        {% elif txn.transaction_type == 'debit' %}
                        <div class="col-span-3 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                            </svg>
                            <span class="text-sm font-medium text-gray-900 capitalize">{{txn.transaction_type}}</span>
                        </div>
                        {% endif %}

                        <div class="col-span-4 text-sm text-gray-600 flex items-center">
                            <span class="md:hidden font-medium text-gray-600">Date: </span>{{txn.created_at}}
                        </div>
                        <div
                            class="col-span-2 text-sm font-semibold text-green-600 text-right flex items-center justify-end">
                            Rs. {{txn.amount}}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- Transaction 2 -->
                    <!-- <div class="grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 px-4 py-4 hover:bg-gray-50 transition">
                        <div class="col-span-1 md:col-span-3 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                            </svg>
                            <span class="text-sm font-medium text-gray-900">Withdrawal</span>
                        </div>

                        <div class="col-span-1 md:col-span-3 text-sm text-gray-600 md:flex md:items-center">
                            <span class="md:hidden font-medium text-gray-600">Date: </span>Oct 26, 2023
                        </div>
                        <div
                            class="col-span-1 md:col-span-2 text-sm font-semibold text-red-600 md:text-right md:flex md:items-center md:justify-end">
                            -$75.50
                        </div>
                    </div> -->

                    <!-- {% if transaction %}
                    {% for t in transition %}
                    {{t.amount}}
                    {{t.transaction_type}}
                    {% endfor %}
                    {% endif %} -->

                </div>

            </div>
        </div>

    </div>

</div>

<script>
document.getElementById("wallet-form").addEventListener("submit", function (e) {
    e.preventDefault();

    const amount = document.getElementById("amount").value;

    const formData = new FormData();
    formData.append("amount", amount);

    // Step 1 — Create Razorpay Order from backend
    fetch("{% url 'walletList' %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData,
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("Failed to create Razorpay order. Try again.");
            return;
        }

        //Configure Razorpay Options
        const options = {
            key: data.key,
            amount: data.amount, // amount in paise
            currency: data.currency,
            name: "Nuts & Seeds",
            description: "Wallet Top-Up",
            order_id: data.order_id,
            wallet_txn_id:data.wallet_txn_id,


            // On successful payment
            handler: function (response) {
                // Verify payment on backend
                fetch("{% url 'verifyWallet' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    }),
                    credentials: "include"
                })
                .then(res => res.json())
                .then(result => {
                    if (result.status === "success") {
                        alert("₹" + amount + " added to your wallet successfully!");

                        htmx.ajax('GET', '{% url "walletList" %}', '#user-right-content');

                        // window.location.href = "{% url 'walletList' %}";
                    } else {
                        alert(result.message || "Payment verification failed.");
                    }
                })
                .catch(() => {
                    alert("Verification request failed. Please try again.");
                });
            },

            // Optional: Handle popup close or failure
            modal: {
                ondismiss: function () {
                    alert("Payment cancelled.");
                }
            },

            theme: {
                color: "#FF6600"
            }
        };

        //Open Razorpay popup
        const rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(() => {
        alert("Something went wrong while creating Razorpay order.");
    });
});
</script>